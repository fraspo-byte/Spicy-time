<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Spicy Time Premium</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="img/bunny.png">

    <style>
        :root {
            --cyan: #70f3ff; --purple: #8e44ad; --accent: #ff2d55;
            --bg: #0d0b1a; --glass: rgba(255, 255, 255, 0.08);
            --gold: #d4af37; --alc: #f59e0b;
            --soft: #70f3ff; --hot: #ff00ff; --hard: #ff2d55;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            background: #0d0b1a; color: #fff; margin: 0; padding: 0; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .bg-mesh { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #0d0b1a; }
        .blob { position: absolute; width: 450px; height: 450px; background: var(--purple); filter: blur(100px); border-radius: 50%; opacity: 0.15; animation: move 25s infinite alternate ease-in-out; }
        @keyframes move { 0% { transform: translate(0, 0); } 100% { transform: translate(120px, 200px); } }

        /* NAV */
        .top-nav { padding: 50px 20px 10px; display: grid; grid-template-columns: 80px 1fr 80px; align-items: center; height: 110px; z-index: 100; }
        .back-btn { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); color: var(--cyan); padding: 10px; border-radius: 15px; font-size: 0.7rem; visibility: hidden; font-weight: 900; text-transform: uppercase; cursor: pointer; }
        .app-title { font-size: 1.1rem; letter-spacing: 5px; color: #fff; text-transform: uppercase; font-weight: 900; text-align: center; text-shadow: 0 0 10px var(--cyan); }
        #cloud-dot { width: 10px; height: 10px; border-radius: 50%; background: #444; justify-self: center; box-shadow: 0 0 5px #000; transition: 0.5s; }

        .view { display: none; flex-direction: column; flex-grow: 1; padding: 0 20px; overflow: hidden; }
        .view.active { display: flex; animation: viewIn 0.3s ease-out; }

        /* MENU */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .menu-card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; padding: 25px 10px; text-align: center; backdrop-filter: blur(15px); cursor: pointer; }
        .menu-card img { width: 50px; height: 50px; margin-bottom: 12px; filter: drop-shadow(0 0 8px var(--cyan)); }
        .menu-card span { display: block; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; color: var(--cyan); letter-spacing: 1px; }

        /* NEON TABS */
        .lvl-tab { font-size: 0.8rem; font-weight: 900; opacity: 0.15; cursor: pointer; transition: 0.4s; filter: grayscale(1); }
        .lvl-tab.active { opacity: 1; transform: scale(1.1); filter: grayscale(0); }
        #l1.active { color: var(--soft); text-shadow: 0 0 15px var(--soft); }
        #l2.active { color: var(--hot); text-shadow: 0 0 15px var(--hot); }
        #l3.active { color: var(--hard); text-shadow: 0 0 15px var(--hard); }

        /* GESTIONE */
        .scroll-area { overflow-y: auto; flex-grow: 1; padding-bottom: 100px; }
        .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding: 5px 0; }
        .filter-chip { background: var(--glass); padding: 8px 15px; border-radius: 15px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; border: 1px solid transparent; }
        .filter-chip.active { border-color: var(--cyan); color: var(--cyan); box-shadow: 0 0 10px var(--cyan); }

        .challenge-item { 
            background: #ffffff; color: #0d0b1a; padding: 20px; border-radius: 25px; 
            margin-bottom: 15px; display: flex; flex-direction: column; gap: 15px; 
            border-left: 10px solid var(--cyan); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .item-text { font-size: 1.1rem; font-weight: 700; line-height: 1.3; }
        .item-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .icon-btn { background: #f0f0f0; border: none; width: 45px; height: 45px; border-radius: 12px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* POP-UP MODAL */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); 
            display: none; align-items: center; justify-content: center; z-index: 2000;
            padding: 20px;
        }
        .modal-content { 
            background: #0d0b1a; border: 2px solid var(--cyan); border-radius: 35px; 
            width: 100%; max-width: 450px; padding: 30px; box-shadow: 0 0 30px rgba(112,243,255,0.2);
        }

        /* INPUTS */
        .input-group { background: var(--glass); padding: 20px; border-radius: 25px; margin-bottom: 20px; }
        textarea, select, input[type=number] { 
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); 
            color: white; padding: 15px; border-radius: 15px; margin-bottom: 12px; font-size: 1rem;
        }

        /* GAME ELEMENTS */
        #card-stack, #scenario-stack { position: relative; flex-grow: 1; margin: 15px 0; display: flex; align-items: center; justify-content: center; }
        .main-card { position: absolute; width: 90%; height: 100%; max-height: 480px; background: #fff; color: #0d0b1a; border-radius: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 35px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8); transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        #timer-ui { display: none; margin-bottom: 20px; background: rgba(0,0,0,0.85); padding: 12px 30px; border-radius: 40px; align-items: center; gap: 15px; border: 1px solid var(--cyan); align-self: center; box-shadow: 0 0 15px var(--cyan); }
        .btn-action { width: 100%; padding: 20px; border-radius: 25px; border: 2px solid var(--cyan); font-weight: 900; text-transform: uppercase; background: rgba(112, 243, 255, 0.05); color: var(--cyan); letter-spacing: 2px; cursor: pointer; margin-bottom: 30px; }

        /* SWITCH */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(20px); }
        input:checked + .slider { background: var(--alc); }
    </style>
</head>
<body>

    <div class="bg-mesh"><div class="blob one"></div></div>

    <div class="top-nav">
        <button id="btn-back" class="back-btn" onclick="openView('home')">BACK</button>
        <div class="app-title">Spicy Time</div>
        <div id="cloud-dot"></div>
    </div>

    <!-- HOME -->
    <div id="view-home" class="view active">
        <div class="menu-grid">
            <div class="menu-card" onclick="openView('game')"><img src="img/dice.png"><span>Gioca Carte</span></div>
            <div class="menu-card" onclick="openView('scenario')"><img src="img/xxx.png"><span>Scenari Hot</span></div>
            <div class="menu-card" onclick="openView('edit-cards')"><img src="img/bunny.png"><span>Gestione Carte</span></div>
            <div class="menu-card" onclick="openView('edit-scenarios')"><img src="img/vibe.png"><span>Gestione Scenari</span></div>
        </div>
    </div>

    <!-- GAME -->
    <div id="view-game" class="view">
        <div style="display:flex; flex-direction:column; align-items:center; gap:12px; margin-bottom:15px; z-index:1000;">
            <div style="display:flex; align-items:center; gap:20px;">
                <div style="display:flex; align-items:center; gap:8px; font-size:0.6rem; color:var(--alc); font-weight:bold;">DRINK MODE <label class="switch"><input type="checkbox" id="alc-toggle" onchange="toggleAlcohol()"><span class="slider"></span></label></div>
                <div id="gold-mode-ui" style="display:none; align-items:center; gap:8px; font-size:0.6rem; color:var(--gold); font-weight:bold;">üëë MODE <label class="switch"><input type="checkbox" id="gold-toggle" onchange="isGoldEnabled = this.checked"><span class="slider"></span></label></div>
            </div>
            <div style="display:flex; gap:25px;">
                <span onclick="setLvl(1)" id="l1" class="lvl-tab active">SOFT</span>
                <span onclick="setLvl(2)" id="l2" class="lvl-tab">HOT</span>
                <span onclick="setLvl(3)" id="l3" class="lvl-tab">HARD</span>
            </div>
        </div>
        <div id="card-stack"><div class="main-card"><h1>üé≤</h1><p>PRONTI?</p></div></div>
        <div id="timer-ui"><span id="timer-val">00:00</span><button onclick="handleTimer()" id="timer-btn" style="background:var(--cyan); border:none; width:45px; height:45px; border-radius:50%; cursor:pointer;">‚ñ∂</button></div>
        <button class="btn-action" onclick="generateChallenge()">Prossima Sfida</button>
    </div>

    <!-- SCENARIO -->
    <div id="view-scenario" class="view">
        <div id="scenario-stack"><div class="main-card"><h1>üé¨</h1><p>NUOVO SCENARIO?</p></div></div>
        <button class="btn-action" onclick="generateScenario()">Prossima Scena</button>
    </div>

    <!-- GESTIONE CARTE -->
    <div id="view-edit-cards" class="view">
        <div class="scroll-area">
            <div id="form-cards-add"></div>
            <div class="filter-bar">
                <span class="filter-chip active" onclick="setFilter('all', this)">Tutte</span>
                <span class="filter-chip" onclick="setFilter(1, this)">Soft</span>
                <span class="filter-chip" onclick="setFilter(2, this)">Hot</span>
                <span class="filter-chip" onclick="setFilter(3, this)">Hard</span>
                <span class="filter-chip" onclick="setFilter('alc', this)">Drink</span>
            </div>
            <div id="list-cards"></div>
        </div>
    </div>

    <!-- GESTIONE SCENARI -->
    <div id="view-edit-scenarios" class="view">
        <div class="scroll-area">
            <div id="form-scenarios-add"></div>
            <div id="list-scenarios"></div>
        </div>
    </div>

    <!-- MODALE DI MODIFICA -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title" style="color:var(--cyan); margin-top:0;">Modifica</h2>
            <textarea id="modal-txt" rows="4"></textarea>
            <div id="modal-extra-fields">
                <select id="modal-lvl">
                    <option value="1">Soft</option><option value="2">Hot</option><option value="3">Hard</option><option value="4">Scenario</option>
                </select>
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                    <input type="number" id="modal-time" placeholder="Timer (sec)" style="margin:0; flex:1;">
                    <label id="modal-alc-label" style="color:var(--alc); font-size:0.8rem; display:flex; align-items:center; gap:8px;">
                        ALC üçπ <label class="switch"><input type="checkbox" id="modal-alc"><span class="slider"></span></label>
                    </label>
                </div>
            </div>
            <button class="btn-action" style="background:var(--cyan); color:black; margin-bottom:10px;" onclick="saveModalEdit()">CONFERMA MODIFICA</button>
            <button class="btn-action" style="background:transparent; border-color:#555; color:#aaa;" onclick="closeModal()">ANNULLA</button>
        </div>
    </div>

    <script>
        const CLOUD_URL = "https://script.google.com/macros/s/AKfycbz5tR2NVhlDzc6M-8AMBO5OE6r225X3miVhfF05YZYQB5oM-i9_bx9DlWNzRgcC85p3/exec";
        const aCtx = new (window.AudioContext || window.webkitAudioContext)();
        const players = ["Eva", "Francesco"];

        let db = { 1: [], 2: [], 3: [], 4: [] }, decks = { 1: [], 2: [], 3: [], 4: [] };
        let hardCount = 0, cardsSinceLastOrgasmo = 6, isGoldEnabled = false;
        let curLvl = 1, isAlc = false, timer = null, timeLeft = 0, currentFilter = 'all', originalText = "";

        async function syncDB() {
            try {
                const res = await fetch(`${CLOUD_URL}?t=${Date.now()}`);
                const data = await res.json();
                db = { 1: [], 2: [], 3: [], 4: [] };
                data.forEach(item => {
                    const l = parseInt(item.livello);
                    if(db[l]) db[l].push({ t: item.testo, s: parseInt(item.timer)||0, alc: item.alcolica });
                });
                document.getElementById('cloud-dot').style.background = "#00ff00";
                renderAllLists();
            } catch (e) { document.getElementById('cloud-dot').style.background = "#ff0000"; }
        }

        // --- GIOCO ---
        function generateChallenge() {
            if (aCtx.state === 'suspended') aCtx.resume();
            resetTimerLogic(); document.getElementById('timer-ui').style.display = 'none';
            const container = document.getElementById('card-stack');

            if (curLvl === 3 && isGoldEnabled && hardCount > 15 && cardsSinceLastOrgasmo > 5 && Math.random() < 0.05) {
                createCard(container, `<div style="font-size:3rem;">üëë</div>Eva, ti sei meritata un <span style="color:var(--accent)">orgasmo</span> ;)`, true);
                cardsSinceLastOrgasmo = 0; return;
            }
            if(curLvl === 3) { hardCount++; cardsSinceLastOrgasmo++; }

            if (decks[curLvl].length === 0) decks[curLvl] = [...db[curLvl].filter(c => isAlc || !c.alc)].sort(() => Math.random() - 0.5);
            const item = decks[curLvl].pop();
            if (!item) return;

            createCard(container, (item.alc?'üçπ ':'') + item.t.replace(/@A/g, `<strong>${players[0]}</strong>`).replace(/@B/g, `<strong>${players[1]}</strong>`));
            if(item.s > 0) { timeLeft = item.s; document.getElementById('timer-ui').style.display = 'flex'; updateTUI(); }
        }

        function generateScenario() {
            if (decks[4].length === 0) decks[4] = [...db[4]].sort(() => Math.random() - 0.5);
            const item = decks[4].pop();
            if (!item) return;
            createCard(document.getElementById('scenario-stack'), item.t);
        }

        function createCard(container, html, isGold = false) {
            const card = document.createElement('div');
            card.className = 'main-card ui-vibrate';
            if(isGold) card.style.border = "2px solid var(--gold)";
            card.innerHTML = `<div class="card-txt-box">${html}</div>`;
            container.appendChild(card);
            if(container.children.length > 5) container.removeChild(container.children[0]);
        }

        // --- TIMER ---
        function handleTimer() {
            if(timer) { resetTimerLogic(); } else {
                document.getElementById('timer-btn').innerHTML = '‚è∏';
                timer = setInterval(() => {
                    timeLeft--; updateTUI();
                    if(timeLeft <= 5 && timeLeft > 0) {
                        const o = aCtx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(800, aCtx.currentTime);
                        const g = aCtx.createGain(); g.gain.exponentialRampToValueAtTime(0.001, aCtx.currentTime+0.1);
                        o.connect(g); g.connect(aCtx.destination); o.start(); o.stop(aCtx.currentTime+0.1);
                    }
                    if(timeLeft <= 0) { resetTimerLogic(); }
                }, 1000);
            }
        }
        function resetTimerLogic() { clearInterval(timer); timer = null; if(document.getElementById('timer-btn')) document.getElementById('timer-btn').innerHTML = '‚ñ∂'; }
        function updateTUI() { let m = Math.floor(timeLeft / 60), s = timeLeft % 60; document.getElementById('timer-val').innerText = `${m}:${s < 10 ? '0'+s : s}`; }

        // --- GESTIONE MODALE ---
        function openEditModal(txt, lvl, time, alc) {
            originalText = txt;
            document.getElementById('modal-txt').value = txt;
            document.getElementById('modal-lvl').value = lvl;
            document.getElementById('modal-time').value = time;
            document.getElementById('modal-alc').checked = alc;
            
            // Nascondi timer/alc se √® uno scenario
            document.getElementById('modal-lvl').style.display = (lvl == 4) ? 'none' : 'block';
            document.getElementById('modal-time').style.display = (lvl == 4) ? 'none' : 'block';
            document.getElementById('modal-alc-label').style.display = (lvl == 4) ? 'none' : 'flex';
            document.getElementById('modal-title').innerText = (lvl == 4) ? "Modifica Scenario" : "Modifica Carta";

            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }

        async function saveModalEdit() {
            const newTxt = document.getElementById('modal-txt').value;
            if(!newTxt) return;
            const btn = document.querySelector('#edit-modal .btn-action');
            btn.innerText = "Sincronizzazione...";
            
            // Elimina vecchia
            await fetch(`${CLOUD_URL}?${new URLSearchParams({action:'delete', testo: originalText})}`, {mode:'no-cors'});
            
            // Aggiungi nuova
            const params = {
                action: 'add',
                livello: document.getElementById('modal-lvl').value,
                testo: newTxt,
                timer: document.getElementById('modal-time').value || 0,
                alcolica: document.getElementById('modal-alc').checked
            };
            await fetch(`${CLOUD_URL}?${new URLSearchParams(params)}`, {mode:'no-cors'});
            
            closeModal();
            btn.innerText = "CONFERMA MODIFICA";
            setTimeout(syncDB, 1000);
        }

        // --- RENDER LISTE ---
        function renderFormAdd(id, isScenario) {
            const container = document.getElementById(id);
            container.innerHTML = `
                <div class="input-group">
                    <h3 style="color:var(--cyan); margin-top:0;">${isScenario?'NUOVO SCENARIO':'NUOVA CARTA'}</h3>
                    ${isScenario ? '' : `<select id="add-lvl-${id}"><option value="1">Soft</option><option value="2">Hot</option><option value="3">Hard</option></select>`}
                    <textarea id="add-txt-${id}" placeholder="Testo sfida..."></textarea>
                    <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                        ${isScenario ? '' : `<input type="number" id="add-time-${id}" placeholder="Timer (sec)" style="margin:0; flex:1;">`}
                        ${!isScenario ? `<label style="color:var(--alc); font-size:0.7rem; display:flex; align-items:center; gap:8px;">ALC üçπ <label class="switch"><input type="checkbox" id="add-alc-${id}"><span class="slider"></span></label></label>` : ''}
                    </div>
                    <button class="btn-action" style="background:var(--cyan); color:black; margin:0;" onclick="submitNew('${id}', ${isScenario?4:0})">SALVA NEL CLOUD</button>
                </div>`;
        }

        async function submitNew(id, forceLvl) {
            const txt = document.getElementById(`add-txt-${id}`).value;
            if(!txt) return;
            const params = {
                action: 'add',
                livello: forceLvl || document.getElementById(`add-lvl-${id}`).value,
                testo: txt,
                timer: document.getElementById(`add-time-${id}`)?.value || 0,
                alcolica: document.getElementById(`add-alc-${id}`)?.checked || false
            };
            await fetch(`${CLOUD_URL}?${new URLSearchParams(params)}`, {mode:'no-cors'});
            document.getElementById(`add-txt-${id}`).value = "";
            setTimeout(syncDB, 1000);
        }

        function renderListSection(id, lvls) {
            const container = document.getElementById(id); container.innerHTML = "";
            lvls.forEach(l => {
                db[l].forEach(item => {
                    if(id === 'list-cards') {
                        if(currentFilter !== 'all' && currentFilter !== 'alc' && currentFilter != l) return;
                        if(currentFilter === 'alc' && !item.alc) return;
                    }
                    const div = document.createElement('div');
                    div.className = "challenge-item";
                    div.style.borderLeftColor = l==1?'var(--soft)':l==2?'var(--hot)':l==3?'var(--hard)':'var(--purple)';
                    div.innerHTML = `<div class="item-text">${item.alc?'üçπ ':''}${item.t}</div>
                        <div class="item-actions">
                            <button class="icon-btn" onclick="openEditModal('${item.t.replace(/'/g, "\\'")}', ${l}, ${item.s}, ${item.alc})">‚úèÔ∏è</button>
                            <button class="icon-btn" style="color:var(--accent)" onclick="deleteItem('${item.t.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                        </div>`;
                    container.appendChild(div);
                });
            });
        }

        async function deleteItem(txt) { if(confirm("Eliminare?")) { await fetch(`${CLOUD_URL}?${new URLSearchParams({action:'delete', testo: txt})}`, {mode:'no-cors'}); setTimeout(syncDB, 1000); } }
        function setFilter(f, el) { currentFilter = f; document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); renderListSection('list-cards', [1,2,3]); }
        function renderAllLists() { renderListSection('list-cards', [1,2,3]); renderListSection('list-scenarios', [4]); renderFormAdd('form-cards-add', false); renderFormAdd('form-scenarios-add', true); }
        function openView(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById('view-' + id).classList.add('active'); document.getElementById('btn-back').style.visibility = (id === 'home' ? 'hidden' : 'visible'); resetTimerLogic(); if(id.includes('edit')) renderAllLists(); }
        function setLvl(l) { curLvl = l; document.querySelectorAll('.lvl-tab').forEach((t, i) => t.classList.toggle('active', (i+1 === l))); document.getElementById('gold-mode-ui').style.display = (l === 3 ? 'flex' : 'none'); }
        function toggleAlcohol() { isAlc = document.getElementById('alc-toggle').checked; decks = {1:[], 2:[], 3:[], 4:[]}; }

        syncDB();
        setInterval(syncDB, 30000);
    </script>
</body>
</html>
